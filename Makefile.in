#
# sample Makefile for Objective Caml
# Copyright (C) 2001 Jean-Christophe FILLIATRE
#
# modified 10/26/2003 by Paul Pelzl, for the purpose of building Orpie
# 
# This library is free software; you can redistribute it and/or
# modify it under the terms of the GNU Library General Public
# License version 2, as published by the Free Software Foundation.
# 
# This library is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
# 
# See the GNU Library General Public License version 2 for more details
# (enclosed in the file LGPL).

# where to install the binaries
prefix=@prefix@
exec_prefix=@exec_prefix@
BINDIR=@bindir@

# where to install the man page
MANDIR=@mandir@

# other variables set by ./configure
OCAMLC       = @OCAMLC@
OCAMLOPT     = @OCAMLOPT@
OCAMLDEP     = @OCAMLDEP@
OCAMLLIB     = @OCAMLLIB@
OCAMLBEST    = @OCAMLBEST@
OCAMLVERSION = @OCAMLVERSION@
OCAMLWIN32   = @OCAMLWIN32@
EXE          = @EXE@

CURSES_LIB = @CURSES_LIB@
GSL_LIB    = @GSL_LIB@

INCLUDES = -I ./curses -I ./gsl
BFLAGS   = -pp camlp4o -g $(INCLUDES)
OFLAGS   = -pp camlp4o $(INCLUDES)
BLFLAGS  = -custom -cclib '$(CURSES_LIB) $(GSL_LIB)'
OLFLAGS  = -cclib '$(CURSES_LIB) $(GSL_LIB)'
DEPFLAGS = -pp camlp4o

# main target
#############

NAME  = orpie
NAME2 = orpie-curses-keys

all: $(OCAMLBEST)



# bytecode and native-code compilation
######################################

CMO = big_int_str.cmo gsl_assist.cmo install.cmo operations.cmo rcfile.cmo \
		utility.cmo rpc_stack.cmo add.cmo sub.cmo mult.cmo div.cmo inv.cmo pow.cmo rpc_calc.cmo \
		interface.cmo interface_draw.cmo interface_main.cmo main.cmo
CMX = $(CMO:.cmo=.cmx)
CMA = nums.cma bigarray.cma str.cma unix.cma
CMXA = $(CMA:.cma=.cmxa)

CURSES_BOBJS = curses/ml_curses.o curses.cmo
CURSES_OOBJS = curses/ml_curses.o curses.cmx

GSL_CMO = gsl_error.cmo gsl_blas.cmo gsl_complex.cmo gsl_matrix.cmo gsl_matrix_complex.cmo \
		gsl_vector.cmo gsl_vector_complex.cmo gsl_vector_flat.cmo gsl_matrix_flat.cmo \
		gsl_vector_complex_flat.cmo gsl_matrix_complex_flat.cmo gsl_vectmat.cmo \
		gsl_permut.cmo gsl_linalg.cmo gsl_fun.cmo
GSL_CMX = $(GSL_CMO:.cmo=.cmx)
GSL_COBJS = gsl/mlgsl_error.o gsl/mlgsl_blas.o gsl/mlgsl_blas_complex.o gsl/mlgsl_complex.o \
		 gsl/mlgsl_matrix_complex.o gsl/mlgsl_matrix_double.o gsl/mlgsl_vector_double.o gsl/mlgsl_permut.o \
		 gsl/mlgsl_linalg.o gsl/mlgsl_linalg_complex.o gsl/mlgsl_fun.o gsl/mlgsl_math.o
GSL_BOBJS = $(GSL_COBJS) $(GSL_CMO)
GSL_OOBJS = $(GSL_COBJS) $(GSL_CMX)

GENERATED = version.ml

byte: $(NAME).byte $(NAME2).byte
opt: $(NAME).opt $(NAME2).opt

$(NAME).byte: subdirs_byte $(CMO)
	$(OCAMLC) $(BFLAGS) $(BLFLAGS) -o $@ $(CURSES_BOBJS) $(CMA) $(GSL_BOBJS) $(CMO) 

$(NAME2).byte: subdirs_byte utility.cmo curses-keys.cmo
	$(OCAMLC) $(BFLAGS) $(BLFLAGS) -o $@ $(CURSES_BOBJS) $(CMA) utility.cmo curses-keys.cmo

$(NAME).opt: subdirs_opt $(CMX)
	$(OCAMLOPT) $(OFLAGS) $(OLFLAGS) -o $@ $(CURSES_OOBJS) $(CMXA) $(GSL_OOBJS) $(CMX)

$(NAME2).opt: subdirs_opt utility.cmx curses-keys.cmx
	$(OCAMLOPT) $(OFLAGS) $(OLFLAGS) -o $@ $(CURSES_OOBJS) $(CMXA) utility.cmx curses-keys.cmx


# curses and gsl bindings
#####################################

SUBDIRS = curses gsl

.PHONY: subdirs_byte subdirs_opt $(SUBDIRS)

subdirs_byte: 
	for dir in $(SUBDIRS); do \
	export BUILD_TYPE=byte && $(MAKE) -C $$dir; \
	done

subdirs_opt: $(SUBDIRS)
	for dir in $(SUBDIRS); do \
	export BUILD_TYPE=opt && $(MAKE) -C $$dir; \
	done

VERSION=1.0

version.ml: Makefile
	echo "let version = \""$(VERSION)"\"" > version.ml
	echo "let date = \""`date`"\"" >> version.ml


# installation
##############

install-indep: 
	mkdir -p $(BINDIR)
	mkdir -p $(MANDIR)/man1
	cp -f $(NAME).1 $(MANDIR)/man1
	install -m 644 orpierc $(prefix)/etc

install: install-indep
	cp -f $(NAME).$(OCAMLBEST) $(BINDIR)/$(NAME)$(EXE)
	cp -f $(NAME2).$(OCAMLBEST) $(BINDIR)/$(NAME2)$(EXE)

install-byte: install-indep
	cp -f $(NAME).byte $(BINDIR)/$(NAME)$(EXE)
	cp -f $(NAME2).byte $(BINDIR)/$(NAME2)$(EXE)

install-opt: install-indep
	cp -f $(NAME).opt $(BINDIR)/$(NAME)$(EXE)
	cp -f $(NAME2).opt $(BINDIR)/$(NAME2)$(EXE)

# documentation
###############

DOCFILES=manual.ps manual.html

doc: $(DOCFILES)

# export
########

EXPORTDIR=$(NAME)-$(VERSION)
TAR=$(EXPORTDIR).tar

FTP = $$HOME/ftp/$(NAME)
WWW = $$HOME/WWW/$(NAME)

FILES = *.ml* $(NAME).1 manual.tex	     \
	Makefile.in configure configure.in   \
	.depend README INSTALL COPYING GPL CHANGES

export: source binary export-doc
	cp README COPYING GPL CHANGES $(FTP)

source: 
	mkdir -p export/$(EXPORTDIR)
	cp $(FILES) export/$(EXPORTDIR)
	cd export ; tar cf $(TAR) $(EXPORTDIR) ; gzip -f --best $(TAR)
	cp export/$(TAR).gz $(FTP)

export-doc: $(DOCFILES)
	gzip -c manual.ps > $(FTP)/manual.ps.gz
	cp manual.html $(WWW)

BINARY = $(EXPORTDIR)-$(OSTYPE)
BINARYTAR=$(BINARY).tar

BINARYFILES = README INSTALL COPYING GPL $(NAME).1

binary: $(NAME).$(OCAMLBEST) $(DOCFILES)
	mkdir -p export/$(BINARY)
	cp $(BINARYFILES) $(DOCFILES) export/$(BINARY)
	cp $(NAME).$(OCAMLBEST) export/$(BINARY)/$(NAME)
	(cd export; tar czf $(BINARY).tar.gz $(BINARY))
	cp export/$(BINARY).tar.gz $(FTP)


# generic rules
###############

.SUFFIXES: .mli .ml .cmi .cmo .cmx .mll .mly

.mli.cmi:
	$(OCAMLC) -c $(BFLAGS) $<

.ml.cmo:
	$(OCAMLC) -c $(BFLAGS) $<

.ml.o:
	$(OCAMLOPT) -c $(OFLAGS) $<

.ml.cmx:
	$(OCAMLOPT) -c $(OFLAGS) $<

.mll.ml:
	$(OCAMLLEX) $<

.mly.ml:
	$(OCAMLYACC) -v $<

.mly.mli:
	$(OCAMLYACC) -v $<

# Emacs tags
############

tags:
	find . -name "*.ml*" | sort -r | xargs \
	etags "--regex=/let[ \t]+\([^ \t]+\)/\1/" \
	      "--regex=/let[ \t]+rec[ \t]+\([^ \t]+\)/\1/" \
	      "--regex=/and[ \t]+\([^ \t]+\)/\1/" \
	      "--regex=/type[ \t]+\([^ \t]+\)/\1/" \
              "--regex=/exception[ \t]+\([^ \t]+\)/\1/" \
	      "--regex=/val[ \t]+\([^ \t]+\)/\1/" \
	      "--regex=/module[ \t]+\([^ \t]+\)/\1/"

# Makefile is rebuilt whenever Makefile.in or configure.in is modified
######################################################################

Makefile: Makefile.in config.status
	./config.status

config.status: configure
	./config.status --recheck

configure: configure.in
	autoconf 

# clean
#######

partly-clean::
	rm -f *.cm[iox] *.o *~
	rm -f $(GENERATED) parser.output
	rm -f $(NAME).byte $(NAME).opt $(NAME2).byte $(NAME2).opt
	rm -f *.aux *.log $(NAME).tex $(NAME).dvi $(NAME).ps

clean:: partly-clean
	cd curses && $(MAKE) clean
	cd gsl && $(MAKE) clean

dist-clean distclean:: clean
	cd curses && $(MAKE) distclean
	cd gsl && $(MAKE) distclean
	rm -f Makefile config.cache config.log config.status install.ml

# depend
########

.depend depend:: $(GENERATED)
	rm -f .depend
	$(OCAMLDEP) $(DEPFLAGS) $(INCLUDES) *.ml *.mli > .depend

include .depend


# arch-tag: DO_NOT_CHANGE_bdb62873-ffd0-4d79-819e-880467e18f28 
